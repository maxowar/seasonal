<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Season and Periods</title>

    <style>
        #timeline {

        }

        #timeline span {
            display: block;
            height: 20px;
            width: 20px;
            padding: 2px;
            background-color: #00ffaf;
            margin: 0;
            border: 1px solid #ccc;
            float: left;
        }

        #timeline span:hover {
            background-color: #0091cc;
        }

        #timeline span.split::after,
        #timeline span:hover::after {
            background-color: #ffbd3a;
            display: block;
            height: 25px;
            width: 14px;
            position: relative;
            top: -53px;
            left: 23px;
            content: '';
        }

        #timeline .month {
            clear: left;
        }
    </style>

    <script>

        /**
         *  Rapresent a delta of time
         *
         * @param start Date
         * @param end Date
         * @constructor
         */
        let Period = function (start, end) {
            this.start = start;
            this.end = end;
        };
        /**
         * Check if the given date in inside the range of the current Period
         *
         * @param date Date
         */
        Period.prototype.contains = function (date) {
            return this.start.getTime() < date.getTime() && this.end.getTime() > date.getTime();
        };

        Period.prototype.toString = function () {
            return '(' + this.start.toDateString() + ', ' + this.end.toDateString() + ')';
        };

        /**
         * A semantically named collection of Periods
         *
         * @param name
         * @param start
         * @param end
         * @param periods
         * @constructor
         */
        let Season = function (name, start, end, periods) {
            this.constructor = Period;
            this.periods = Array.isArray(periods) ?
                periods :
                [new Period(start, end)];
            this.name = name;
            this.constructor(start, end);
        };
        Season.prototype.count = function () {
            return this.periods.length;
        };
        Season.prototype.periods = function () {
            return this.periods;
        };
        /**
         *
         * @param when Date
         */
        Season.prototype.split = function (when) {
            if (when.constructor !== Date) {
                throw new TypeError("Must be of type Date");
            }

            let it = this.periods[Symbol.iterator]();

            let prev;
            let cursor = it.next();
            let position = 1;
            while (!cursor.done) {
                prev = cursor.value;
                if (prev.contains(when)) {
                    let newPeriod = new Period(when, prev.end);
                    prev.end = new Date(when.getFullYear(),when.getMonth(), when.getDate() - 1);
                    this.periods.splice(position, 0, newPeriod);
                }
                position++;
                cursor = it.next();
            }
        };
        Season.prototype.unsplit = function () {

        };
        Season.prototype.toString = function () {
            var serialized = ''
            this.periods.forEach(function (period) {
                 serialized += period.toString();
            });
            return serialized;
        }




        function RangeDateIterator(date, untilDate) {
            var until = new Date(untilDate.getTime());
            var current = new Date(date.getTime());

            this.value = function() {
                return current;
            };

            this.next = function() {
                current = new Date(current.getFullYear(), current.getMonth(), current.getDate() + 1);
            };

            this.valid = function() {
                return current.getTime() <= until.getTime();
            };



        }

        function SeasonRender(seasonToRender, opts) {

            var season = seasonToRender;
            var options = Object.assign({}, defaults(), opts);

            this.render = function() {
                drawDays();
            };

            function drawDays() {
                var it = new RangeDateIterator(season.start, season.end);
                var rootElement = document.getElementById(options.root_element);
                var current_month;
                var monthElement;

                while (it.valid()) {
                    var current = it.value();
                    var dayElement = document.createElement('span');

                    if(current_month != it.value().getMonth()) {
                        current_month = it.value().getMonth();
                        monthElement = createMonthElement(it)
                        rootElement.appendChild(monthElement);
                    }

                    dayElement.textContent = current.getDate();
                    dayElement.addEventListener('click', function (event) {
                        season.split(new Date(Number(this.getAttribute('data-time'))));
                        this.className = 'split';
                    })
                    dayElement.setAttribute('data-date', current.getFullYear() + '_' + current.getMonth() + '_' + current.getDate());
                    dayElement.setAttribute('data-time', current.getTime());
                    dayElement.setAttribute('date-month', current.getMonth());
                    monthElement.appendChild(dayElement);

                    it.next();
                }
            }

            function defaults() {
                return {
                    root_element: 'timeline'
                }
            }
            
            function createMonthElement(it) {
                var div = document.createElement('div');
                div.setAttribute('data-month', it.value().getMonth());
                div.setAttribute('class', 'month');
                var p = document.createElement('p');
                p.textContent = it.value().toLocaleString('it', { month: "long" });
                div.appendChild(p);
                return div;
            }

        }



    </script>

</head>
<body>

<h1>Season and Periods</h1>
<div id="timeline"></div>

<div style="clear: both;">
    <button type="submit" id="send">Send</button>
</div>

<h2>Result</h2>
<div id="result"></div>


<script>
    var season = new Season(
        'Stagione 2018',
        new Date(2018, 3, 1),
        new Date(2018, 4, 15)
    );


    season.split(new Date(2018, 3,15));
    season.split(new Date(2018, 3,13));
    season.split(new Date(2018, 7,15));

    var renderer = new SeasonRender(season);
    renderer.render();

    document.getElementById('send').addEventListener('click', function (event) {
        document.getElementById('result').innerHTML = season.toString();
    });
</script>
</body>
</html>
